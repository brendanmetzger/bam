#!/usr/bin/php
<?php

chdir(dirname(__FILE__).'/..');

define('CONF', parse_ini_file('data/config.ini'));

require 'src/kernel.php';



/*** ROUTING ******************************************************************/



Route::markdown(function($input = null) {
  chdir('views');
  $template = new Template(Document::open('pages/index.html'));
  
  return Render::DOM($template->render());
});


Route::test(function() {
  // echo "A B C D E F";
  exec('stty -icanon');
  // stream_set_blocking($this->input, 0);
  while (1) {
    $key = ord(fgetc($this->input));
    echo $key;
    // if (27 === $key) {
    //   fgetc($this->input);
    //   $key = ord(fgetc($this->input));
    // }
    
    
    
    echo $key . "\n";
  }
  
  // for ($i=0; $i < 10; $i++) {
  //   sleep(1);
  //   echo "\e[1D";
  // }
  // $this->prompt("where is cursor\e[s\e[2DFF\e[u");
});


Route::plain(function() {

  echo Parser::convert(Document::open('views/pages/index.html'));

});



/*** IMPLEMENTATION **********************************************************/



try {
  
  $command = new Command(array_slice($argv,1));
  $output  = Route::compose($command);
  
} catch (Exception | Error $e) {
  
  $output  = sprintf("\n\033[0;31m%s\033[0m\n", $e->getMessage());
  $output .= sprintf("line %s in %s\n", $e->getLine(), $e->getFile());
  
} finally {

  echo $output;
  echo "\n- Finished {$command->action} -\n";
  exit($command->status);
  
}


